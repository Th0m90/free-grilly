<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Free Grilly</title>
    <link rel="stylesheet" type="text/css" href="custom-boostrap.min.css">
    
    <link rel="icon" href="data:,">
    <link rel="manifest" href="./manifest.webmanifest">
    <link rel="apple-touch-icon" href="./icons/icon-192.png" />
    <meta name="theme-color" content="#007bff">
    <!-- Thema stylesheet -->
    <link rel="stylesheet" href="grilly-ui/themes/theme-light.css" id="theme-link">
    <!-- UI library stylesheet -->
    <link rel="stylesheet" href="grilly-ui/grilly-ui.css">
    <!-- JavaScript (alpinejs en je eigen lib) -->
    <script src="https://unpkg.com/alpinejs" defer></script>
    <script src="grilly-ui/grilly-ui.js" defer></script>


  </head>
  <body>

    <div style="position: fixed; top: 1rem; right: 1rem; z-index: 9999;">
        <button class="grilly-button" id="theme-toggle" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">
          🌙 Donker
        </button>
      </div>
            
    <nav class="navbar navbar-expand bg-body-tertiary">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Temperatures</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="probes.html">Probes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="settings.html">Settings</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="update.html">Update</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div style="margin: 1rem 0;">
        <label>
          <input type="checkbox" id="toggleFake" />
          🔧 Gebruik testdata
        </label>
      </div>
      

    <!-- Tijdsselectie -->
<label for="time-range">Tijdsframe:</label>
<select id="time-range">
  <option value="10">Laatste 10 minuten</option>
  <option value="30">Laatste 30 minuten</option>
  <option value="60" selected>Laatste uur</option>
</select>

<!-- Grafiek -->
<div class="grilly-chart-container">
    <canvas id="tempChart" style="width: 100%; height: auto;"></canvas>
  </div>
  

<!-- Probe kaarten -->
<div id="probe-container"></div>


    <!-- Externe Chart.js bibliotheek -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Jouw eigen grafiekscript -->
    <script src="grilly-ui/charts/grilly-chart.js"></script>


      
        
            <div class="col-7 col-lg-5 text-end">
                <span class="badge bg-success" id="grill-battery">BAT <span id="grill-battery-percentage">0</span>% <i id="grill-battery-charging">++</i></span>
                <span class="badge bg-danger" id="grill-wifi-connected">WIFI <span id="grill-wifi-strength">0%</span></span>
            </div>
        </div>
        <!-- <div class="row pt-1 row-cols-2 row-cols-sm-2 row-cols-md-2 row-cols-lg-4 g-2"> -->
        <div class="row">
            <div class="my-2 col-sm-12 col-md-6">
                <div class="card">
                    <div class="card-body py-1 px-2">
                        <div class="row">
                            <div class="col-8">Probe 1&nbsp;&nbsp;<span id="probe-1-status" class="badge text-dark bg-light"></span></div>
                            <div class="col-4 probe-temperature text-end" id="probe-1-temperature">0 C</div>
                            <div class="col-5 col-sm-7"><small>Target temperature</small></div>
                            <div class="col-7 col-sm-5 probe-temperature text-end"><small id="probe-1-target">0 C</small></div>
                            <div class="col-5 col-sm-7"><small>Minimum temperature</small></div>
                            <div class="col-7 col-sm-5 probe-temperature text-end"><small id="probe-1-minimum">0 C</small></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="my-2 col-sm-12 col-md-6">
                <div class="card">
                    <div class="card-body py-1 px-2">
                        <div class="row">
                            <div class="col-8">Probe 2&nbsp;&nbsp;<span id="probe-2-status" class="badge text-dark bg-light"></span></div>
                            <div class="col-4 probe-temperature text-end" id="probe-2-temperature">0 C</div>
                            <div class="col-5 col-sm-7"><small>Target temperature</small></div>
                            <div class="col-7 col-sm-5 probe-temperature text-end"><small id="probe-2-target">0 C</small></div>
                            <div class="col-5 col-sm-7"><small>Minimum temperature</small></div>
                            <div class="col-7 col-sm-5 probe-temperature text-end"><small id="probe-2-minimum">0 C</small></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="my-2 col-sm-12 col-md-6">
                <div class="card">
                    <div class="card-body py-1 px-2">
                        <div class="row">
                            <div class="col-8">Probe 3&nbsp;&nbsp;<span id="probe-3-status" class="badge text-dark bg-light"></span></div>
                            <div class="col-4 probe-temperature text-end" id="probe-3-temperature">0 C</div>
                            <div class="col-5 col-sm-7"><small>Target temperature</small></div>
                            <div class="col-7 col-sm-5 probe-temperature text-end"><small id="probe-3-target">0 C</small></div>
                            <div class="col-5 col-sm-7"><small>Minimum temperature</small></div>
                            <div class="col-7 col-sm-5 probe-temperature text-end"><small id="probe-3-minimum">0 C</small></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="my-2 col-sm-12 col-md-6">
                <div class="card">
                    <div class="card-body py-1 px-2">
                        <div class="row">
                            <div class="col-8">Probe 4&nbsp;&nbsp;<span id="probe-4-status" class="badge text-dark bg-light"></span></div>
                            <div class="col-4 probe-temperature text-end" id="probe-4-temperature">0 C</div>
                            <div class="col-5 col-sm-7"><small>Target temperature</small></div>
                            <div class="col-7 col-sm-5 probe-temperature text-end"><small id="probe-4-target">0 C</small></div>
                            <div class="col-5 col-sm-7"><small>Minimum temperature</small></div>
                            <div class="col-7 col-sm-5 probe-temperature text-end"><small id="probe-4-minimum">0 C</small></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="my-2 col-sm-12 col-md-6">
                <div class="card">
                    <div class="card-body py-1 px-2">
                        <div class="row">
                            <div class="col-8">Probe 5&nbsp;&nbsp;<span id="probe-5-status" class="badge text-dark bg-light"></span></div>
                            <div class="col-4 probe-temperature text-end" id="probe-5-temperature">0 C</div>
                            <div class="col-5 col-sm-7"><small>Target temperature</small></div>
                            <div class="col-7 col-sm-5 probe-temperature text-end"><small id="probe-5-target">0 C</small></div>
                            <div class="col-5 col-sm-7"><small>Minimum temperature</small></div>
                            <div class="col-7 col-sm-5 probe-temperature text-end"><small id="probe-5-minimum">0 C</small></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="my-2 col-sm-12 col-md-6">
                <div class="card">
                    <div class="card-body py-1 px-2">
                        <div class="row">
                            <div class="col-8">Probe 6&nbsp;&nbsp;<span id="probe-6-status" class="badge text-dark bg-light"></span></div>
                            <div class="col-4 probe-temperature text-end" id="probe-6-temperature">0 C</div>
                            <div class="col-5 col-sm-7"><small>Target temperature</small></div>
                            <div class="col-7 col-sm-5 probe-temperature text-end"><small id="probe-6-target">0 C</small></div>
                            <div class="col-5 col-sm-7"><small>Minimum temperature</small></div>
                            <div class="col-7 col-sm-5 probe-temperature text-end"><small id="probe-6-minimum">0 C</small></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="my-2 col-sm-12 col-md-6">
                <div class="card">
                    <div class="card-body py-1 px-2">
                        <div class="row">
                            <div class="col-8">Probe 7&nbsp;&nbsp;<span id="probe-7-status" class="badge text-dark bg-light"></span></div>
                            <div class="col-4 probe-temperature text-end" id="probe-7-temperature">0 C</div>
                            <div class="col-5 col-sm-7"><small>Target temperature</small></div>
                            <div class="col-7 col-sm-5 probe-temperature text-end"><small id="probe-7-target">0 C</small></div>
                            <div class="col-5 col-sm-7"><small>Minimum temperature</small></div>
                            <div class="col-7 col-sm-5 probe-temperature text-end"><small id="probe-7-minimum">0 C</small></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="my-2 col-sm-12 col-md-6">
                <div class="card">
                    <div class="card-body py-1 px-2">
                        <div class="row">
                            <div class="col-8">Probe 8&nbsp;&nbsp;<span id="probe-8-status" class="badge text-dark bg-light"></span></div>
                            <div class="col-4 probe-temperature text-end" id="probe-8-temperature">0 C</div>
                            <div class="col-5 col-sm-7"><small>Target temperature</small></div>
                            <div class="col-7 col-sm-5 probe-temperature text-end"><small id="probe-8-target">0 C</small></div>
                            <div class="col-5 col-sm-7"><small>Minimum temperature</small></div>
                            <div class="col-7 col-sm-5 probe-temperature text-end"><small id="probe-8-minimum">0 C</small></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="bootstrap.min.js" type="text/javascript"></script>
    <script type="text/javascript">

        //Only used during tests, the real implementation uses relative urls
        const base_url = "http://10.30.10.235";
        
        const api_polling_interval = 1000;
        const api_unreachable_intervals = 10;

        const sleep = ms => new Promise(res => setTimeout(res, ms));

        // Vars
        var temp_unit = "C";
        var status_classlist = ["text-dark", "bg-light", "bg-success", "bg-warning", "bg-danger"];


        // Selectors
        const e_probes = new Array(8);
        for(let probe_nr = 1; probe_nr < 9; probe_nr++){
            e_probes[probe_nr] = {};

            e_probes[probe_nr]["status"]              = document.getElementById("probe-" + probe_nr + "-status");
            e_probes[probe_nr]["temperature"]         = document.getElementById("probe-" + probe_nr + "-temperature");
            e_probes[probe_nr]["target_temperature"]  = document.getElementById("probe-" + probe_nr + "-target");
            e_probes[probe_nr]["minimum_temperature"] = document.getElementById("probe-" + probe_nr + "-minimum");
        }

        e_grill_name                      = document.getElementById("grill-name");

        e_grill_battery                   = document.getElementById("grill-battery");
        e_grill_battery_percentage        = document.getElementById("grill-battery-percentage");
        e_grill_battery_charging          = document.getElementById("grill-battery-charging");
        
        e_wifi_connected                  = document.getElementById("grill-wifi-connected");
        e_wifi_strength                   = document.getElementById("grill-wifi-strength");

        let wifi_signal_strength = 0;

        async function pollTemperatures() {
            
            try {
                const response = await fetch(base_url + "/api/grill");
                data = await response.json();
                
                // Grill name
                e_grill_name.textContent = data.name;

                switch(data.temperature_unit){
                    case "celcius":
                        temp_unit = "C";
                        break;
                    case "fahrenheit":
                        temp_unit = "F";
                        break;
                    default:
                        temp_unit = "?";
                }

                // Settings
                
                // Wifi
                if(data['wifi_connected'] == true){
                    e_wifi_connected.classList.remove("bg-danger");

                    wifi_signal_strength = 140 + data['wifi_signal'];
                    e_wifi_strength.textContent = wifi_signal_strength + " %";

                    if(wifi_signal_strength > 60){
                        e_wifi_connected.classList.add("bg-success");
                    } else {
                        e_wifi_connected.classList.add("bg-warning");
                    }
                } else {
                    e_wifi_connected.classList.remove("bg-success");
                    e_wifi_connected.classList.add("bg-danger");
                }

                // battery
                e_grill_battery_percentage.textContent = data.battery_percentage;

                if(data['battery_charging'] == true){
                    e_grill_battery_charging.style.display = "inline-block";
                } else {
                    e_grill_battery_charging.style.display = "none";
                }

                if(data.battery_percentage > 50){
                    e_grill_battery.classList.remove("bg-danger");
                    e_grill_battery.classList.remove("bg-warning");
                    e_grill_battery.classList.add("bg-success");
                } else if(data.battery_percentage > 30){
                    e_grill_battery.classList.remove("bg-danger");
                    e_grill_battery.classList.remove("bg-success");
                    e_grill_battery.classList.add("bg-warning");
                } else {
                    e_grill_battery.classList.remove("bg-warning");
                    e_grill_battery.classList.remove("bg-success");
                    e_grill_battery.classList.add("bg-danger");
                }

                for(let probe_nr = 1; probe_nr < 9; probe_nr++)
                {
                    if(data['probes'][probe_nr - 1]['connected'] == true){
                        e_probes[probe_nr]["temperature"].textContent = data['probes'][probe_nr - 1]['temperature'].toFixed(2) + " " + temp_unit;

                        //* target temperature mode
                        if(data['probes'][probe_nr - 1]['minimum_temperature'] == 0){

                            let temperature_difference = data['probes'][probe_nr - 1]['target_temperature'] - data['probes'][probe_nr - 1]['temperature']

                            if(temperature_difference >= 10){
                                e_probes[probe_nr]["status"].textContent = "Getting ready"
                                e_probes[probe_nr]["status"].classList.remove(...status_classlist);
                                e_probes[probe_nr]["status"].classList.add(...["bg-danger"]);
                            } else if(temperature_difference < 10 && temperature_difference > 0){
                                e_probes[probe_nr]["status"].textContent = "Almost ready"
                                e_probes[probe_nr]["status"].classList.remove(...status_classlist);
                                e_probes[probe_nr]["status"].classList.add(...["bg-warning"]);
                            } else if(temperature_difference <= 0 ){
                                e_probes[probe_nr]["status"].textContent = "Ready!"
                                e_probes[probe_nr]["status"].classList.remove(...status_classlist);
                                e_probes[probe_nr]["status"].classList.add(...["bg-success"]);
                            }
                        }

                        //* temperature range mode
                        if(data['probes'][probe_nr - 1]['minimum_temperature'] != 0){
                        
                            let temperature = data['probes'][probe_nr - 1]['temperature'];
                            let min_temp    = data['probes'][probe_nr - 1]['minimum_temperature'];
                            let max_temp    = data['probes'][probe_nr - 1]['target_temperature'];

                            if(temperature >= min_temp && temperature <= max_temp){
                                e_probes[probe_nr]["status"].textContent = "In range"
                                e_probes[probe_nr]["status"].classList.remove(...status_classlist);
                                e_probes[probe_nr]["status"].classList.add(...["bg-success"]);
                            } else {

                                let temperature_difference = 0;

                                if(temperature < min_temp){
                                    temperature_difference = min_temp - temperature;
                                }
                                if(temperature > max_temp){
                                    temperature_difference = temperature - max_temp;
                                }

                                if(temperature_difference >= 10){
                                    e_probes[probe_nr]["status"].textContent = "Way out of range"
                                    e_probes[probe_nr]["status"].classList.remove(...status_classlist);
                                    e_probes[probe_nr]["status"].classList.add(...["bg-danger"]);
                                } else if(temperature_difference < 10 && temperature_difference > 0){
                                    e_probes[probe_nr]["status"].textContent = "Out of range"
                                    e_probes[probe_nr]["status"].classList.remove(...status_classlist);
                                    e_probes[probe_nr]["status"].classList.add(...["bg-warning"]);
                                }
                            
                            }
                            
                        
                        }


                    }else{
                        e_probes[probe_nr]["temperature"].textContent = "-";

                        e_probes[probe_nr]["status"].textContent = "Disconnected"
                        e_probes[probe_nr]["status"].classList.remove(...status_classlist);
                        e_probes[probe_nr]["status"].classList.add(...["bg-light", "text-dark"]);
                    }
                    
                    e_probes[probe_nr]["minimum_temperature"].textContent = data['probes'][probe_nr - 1]['minimum_temperature'].toFixed(2) + " " + temp_unit;
                    e_probes[probe_nr]["target_temperature"].textContent  = data['probes'][probe_nr - 1]['target_temperature'].toFixed(2) + " " + temp_unit;
                }

            } catch (error) {
                console.error('Grill is unreachable:', error);
            }

        }
        
        async function pollingLoop() {
            await sleep(api_polling_interval);
            pollTemperatures();
            
            pollingLoop();
        }

        pollingLoop();

    </script>


<script>
    const probeColors = ['#007bff', '#dc3545', '#28a745', '#ffc107', '#17a2b8', '#6610f2', '#6f42c1', '#fd7e14'];
    let chart = null;
    let activeProbes = [];
  
    document.addEventListener("DOMContentLoaded", () => {
      const toggleFake = document.getElementById("toggleFake");
  
      // Herstel voorkeur
      const stored = localStorage.getItem("useFakeData") === "true";
      toggleFake.checked = stored;
  
      toggleFake.addEventListener("change", () => {
        localStorage.setItem("useFakeData", toggleFake.checked);
        loadProbes();
      });
  
      loadProbes();
      document.getElementById("time-range").addEventListener("change", () => renderChart(activeProbes));
    });
  
    async function loadProbes() {
      const useFakeData = localStorage.getItem("useFakeData") === "true";
      let probes;
  
      if (useFakeData) {
        probes = [
          { probe_id: 1, temperature: 63.5, target_temperature: 70, connected: true },
          { probe_id: 2, temperature: 59.1, target_temperature: 68, connected: true },
          { probe_id: 3, temperature: 0, target_temperature: 0, connected: false },
          { probe_id: 4, temperature: 61.3, target_temperature: 72, connected: true }
        ];
      } else {
        const DEVICE_IP = localStorage.getItem("grilly-ip") || "192.168.1.123";
        const res = await fetch(`http://${DEVICE_IP}/api/probes`);
        probes = await res.json();
      }
  
      const active = probes.filter(p => p.connected);
      activeProbes = active;
      renderProbes(active);
      renderChart(active);
    }
  
    function renderProbes(probes) {
      const container = document.getElementById("probe-container");
      container.innerHTML = '';
  
      if (!probes.length) {
        container.innerHTML = '<p><em>Geen actieve probes aangesloten.</em></p>';
        return;
      }
  
      probes.forEach((p) => {
        const div = document.createElement("div");
        div.className = "grilly-card";
        div.innerHTML = `
          <h3>Probe ${p.probe_id}</h3>
          <p>Temperatuur: ${p.temperature.toFixed(1)} °C</p>
          <p>Doel: ${p.target_temperature} °C</p>
        `;
        container.appendChild(div);
      });
    }
  
    function renderChart(probes) {
      const minutes = parseInt(document.getElementById("time-range").value);
      const labels = generateTimeLabels(minutes);
  
      const datasets = probes.map((p, i) => ({
        label: `Probe ${p.probe_id}`,
        data: simulateProbeData(p.temperature, labels.length),
        borderColor: probeColors[i % probeColors.length],
        tension: 0.3,
        fill: false
      }));
  
      try {
  if (Chart.getChart("tempChart")) {
    Chart.getChart("tempChart").destroy();
  }
} catch (e) {
  console.warn("Kon bestaande grafiek niet vernietigen:", e);
}


  
      const ctx = document.getElementById("tempChart").getContext("2d");
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets
        },
        options: {
          responsive: true,
          animation: false,
          scales: {
            y: {
              beginAtZero: false,
              title: {
                display: true,
                text: 'Temperatuur (°C)'
              }
            },
            x: {
              title: {
                display: true,
                text: `Tijd (laatste ${minutes} minuten)`
              }
            }
          }
        }
      });
    }
  
    function generateTimeLabels(minutes) {
      const interval = 5;
      const now = new Date();
      return Array.from({ length: minutes / interval }, (_, i) => {
        const t = new Date(now - (minutes - i * interval) * 60000);
        return `${t.getHours()}:${String(t.getMinutes()).padStart(2, '0')}`;
      });
    }
  
    function simulateProbeData(currentTemp, length) {
      return Array.from({ length }, () =>
        (currentTemp + (Math.random() - 0.5) * 0.5).toFixed(2)
      );
    }
  </script>
  
  

<button id="installBtn" class="grilly-button"
  style="position: fixed; bottom: 1rem; right: 1rem; z-index: 9999; display: none;">
  ➕ Installeer app
</button>



<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register(location.pathname.replace(/[^\/]+$/, '') + 'service-worker.js')
          .then((reg) => {
            console.log('✅ Service Worker geregistreerd:', reg.scope);
          })
          .catch((err) => {
            console.error('❌ Service Worker registratie mislukt:', err);
          });
      });
    }
  </script> 
  
  
    <script>
        let deferredPrompt;
      
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          deferredPrompt = e;
      
          const installBtn = document.getElementById('installBtn');
          if (installBtn) {
            installBtn.style.display = 'block';
      
            installBtn.addEventListener('click', () => {
              installBtn.style.display = 'none';
              deferredPrompt.prompt();
      
              deferredPrompt.userChoice.then((choice) => {
                if (choice.outcome === 'accepted') {
                  console.log('✅ PWA geïnstalleerd');
                } else {
                  console.log('❌ Installatie geweigerd');
                }
                deferredPrompt = null;
              });
            });
          }
        });
      </script>
      
      
  </body>
</html>